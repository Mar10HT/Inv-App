<div class="min-h-screen bg-surface p-6">
  <div class="max-w-[1600px] mx-auto">
    <!-- Welcome Section -->
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-foreground mb-2">
        {{ 'DASHBOARD.WELCOME' | translate }}, {{ userName() }}!
      </h1>
      <p class="text-slate-500 text-lg">
        {{ 'DASHBOARD.SUBTITLE' | translate }}
      </p>
    </div>

    <!-- Error State -->
    @if (error()) {
      <div class="bg-rose-950/30 border border-rose-900 rounded-xl p-4 mb-6">
        <div class="flex items-center gap-3">
          <lucide-icon name="AlertCircle" class="!w-5 !h-5 text-rose-400"></lucide-icon>
          <span class="text-rose-400">{{ error() }}</span>
        </div>
      </div>
    }

    <!-- Loading State with Skeleton -->
    @if (loading()) {
      <app-skeleton-dashboard />
    } @else {
      <!-- Stats Cards Component -->
      <app-dashboard-stats [stats]="stats()" />

    <!-- Charts Section Component - Lazy loaded with @defer -->
    @defer (on viewport; prefetch on idle) {
      <app-dashboard-charts
        [widgets]="chartWidgets()"
        [stats]="stats()"
        [categoryStats]="categoryStats()"
        [warehouseStats]="warehouseStats()"
        [statusChartSeries]="statusChartSeries()"
        [statusChartOptions]="statusChartOptions()"
        [categoryChartSeries]="categoryChartSeries()"
        [categoryChartOptions]="categoryChartOptions()"
        [warehouseChartSeries]="warehouseChartSeries()"
        [warehouseChartOptions]="warehouseChartOptions()"
        (widgetDrop)="onChartWidgetDrop($event)" />
    } @placeholder {
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        @for (i of [1, 2, 3]; track i) {
          <div class="bg-surface-variant rounded-xl border border-theme p-6 animate-pulse">
            <div class="h-6 bg-slate-700 rounded w-1/3 mb-4"></div>
            <div class="h-64 bg-slate-800 rounded"></div>
          </div>
        }
      </div>
    } @loading (minimum 200ms) {
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        @for (i of [1, 2, 3]; track i) {
          <div class="bg-surface-variant rounded-xl border border-theme p-6">
            <div class="flex items-center justify-center h-72">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#4d7c6f]"></div>
            </div>
          </div>
        }
      </div>
    }

    <!-- Custom Charts Section -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-foreground">{{ 'DASHBOARD.CUSTOM_CHART.SECTION_TITLE' | translate }}</h3>
        <button
          (click)="openCustomChartDialog()"
          class="flex items-center gap-2 px-4 py-2 bg-[#4d7c6f] text-white rounded-lg hover:bg-[#5d8c7f] transition-colors text-sm font-medium">
          <lucide-icon name="Plus" class="!w-4 !h-4"></lucide-icon>
          {{ 'DASHBOARD.CUSTOM_CHART.ADD' | translate }}
        </button>
      </div>

      @if (customCharts().length === 0) {
        <div class="bg-surface-variant rounded-xl border border-dashed border-[#3a3a3a] p-8 text-center">
          <lucide-icon name="BarChart3" class="!w-10 !h-10 text-slate-700 mb-3 mx-auto"></lucide-icon>
          <p class="text-slate-500 text-sm mb-4">{{ 'DASHBOARD.CUSTOM_CHART.EMPTY' | translate }}</p>
          <button
            (click)="openCustomChartDialog()"
            class="text-[#4d7c6f] hover:text-[#5d8c7f] text-sm font-medium transition-colors">
            {{ 'DASHBOARD.CUSTOM_CHART.CREATE_FIRST' | translate }}
          </button>
        </div>
      } @else {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          @for (chart of customCharts(); track chart.id) {
            <div class="bg-surface-variant rounded-xl border border-theme p-6 hover:border-[#3a3a3a] transition-colors">
              <div class="flex items-center justify-between mb-4">
                <h4 class="text-md font-semibold text-foreground truncate">{{ chart.title }}</h4>
                <div class="flex items-center gap-1">
                  <button
                    (click)="openCustomChartDialog(chart)"
                    class="p-1.5 rounded-lg text-slate-500 hover:text-foreground hover:bg-[#2a2a2a] transition-colors">
                    <lucide-icon name="Pencil" class="!w-4 !h-4"></lucide-icon>
                  </button>
                  <button
                    (click)="deleteCustomChart(chart)"
                    class="p-1.5 rounded-lg text-slate-500 hover:text-rose-400 hover:bg-rose-950/30 transition-colors">
                    <lucide-icon name="Trash2" class="!w-4 !h-4"></lucide-icon>
                  </button>
                </div>
              </div>

              @if (!dataReady()) {
                <div class="flex flex-col items-center justify-center py-8">
                  <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-[#4d7c6f] mb-2"></div>
                  <p class="text-slate-500 text-sm">{{ 'COMMON.LOADING' | translate }}...</p>
                </div>
              } @else if (getCustomChartData(chart).series.length > 0 || (getCustomChartData(chart).series[0]?.data?.length > 0)) {
                @defer (on viewport) {
                  <apx-chart
                    [series]="getCustomChartData(chart).series"
                    [chart]="getCustomChartOptions(chart).chart"
                    [xaxis]="getCustomChartOptions(chart).xaxis"
                    [yaxis]="getCustomChartOptions(chart).yaxis"
                    [colors]="getCustomChartOptions(chart).colors"
                    [grid]="getCustomChartOptions(chart).grid"
                    [plotOptions]="getCustomChartOptions(chart).plotOptions"
                    [dataLabels]="getCustomChartOptions(chart).dataLabels"
                    [legend]="getCustomChartOptions(chart).legend"
                    [labels]="getCustomChartData(chart).labels"
                    [tooltip]="getCustomChartOptions(chart).tooltip">
                  </apx-chart>
                } @placeholder {
                  <div class="h-64 bg-slate-800 rounded animate-pulse"></div>
                }
              } @else {
                <div class="flex flex-col items-center justify-center py-8">
                  <lucide-icon name="BarChart2" class="!w-8 !h-8 text-slate-700 mb-2"></lucide-icon>
                  <p class="text-slate-500 text-sm">{{ 'COMMON.NO_DATA' | translate }}</p>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>

    <!-- Two Column Layout for Tables (Drag & Drop) -->
    <div
      cdkDropList
      cdkDropListOrientation="horizontal"
      (cdkDropListDropped)="onTableWidgetDrop($event)"
      class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      @for (widget of tableWidgets(); track widget) {
        <div cdkDrag class="bg-surface-variant border border-theme rounded-xl overflow-hidden transition-colors">
          <!-- Transactions Widget -->
          @if (widget === 'transactions') {
            <app-dashboard-transactions
              [transactions]="recentTransactions()"
              (viewAll)="viewAllTransactions()" />
          }

          <!-- Low Stock Widget -->
          @if (widget === 'lowStock') {
            <app-dashboard-low-stock
              [items]="lowStockItems()"
              (viewAll)="viewAllInventory()"
              (itemClick)="viewItem($event)" />
          }

          <!-- Drag Placeholder -->
          <div *cdkDragPlaceholder class="bg-[#2a2a2a] rounded-xl border-2 border-dashed border-[#4d7c6f] h-full min-h-[300px]"></div>
        </div>
      }
    </div>

    <!-- Recent Items Table -->
    <div class="bg-surface-variant border border-theme rounded-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-theme flex items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold text-foreground">{{ 'DASHBOARD.RECENT_ITEMS' | translate }}</h2>
          <p class="text-slate-500 text-sm mt-1">{{ 'DASHBOARD.MANAGE_ITEMS' | translate }}</p>
        </div>
        <button
          (click)="viewAllInventory()"
          class="text-sm text-sky-400 hover:text-sky-300 transition-colors">
          {{ 'COMMON.VIEW_ALL' | translate }}
        </button>
      </div>

      @if (items().length === 0 && !loading()) {
        <!-- Empty State -->
        <div class="flex flex-col items-center justify-center py-16">
          <lucide-icon name="Package" class="!w-14 !h-14 text-slate-700 mb-4"></lucide-icon>
          <p class="text-slate-500 text-lg mb-2">{{ 'INVENTORY.NO_ITEMS' | translate }}</p>
          <p class="text-slate-600 text-sm mb-6">{{ 'INVENTORY.NO_ITEMS_DESC' | translate }}</p>
          <button
            (click)="addNewItem()"
            class="bg-[#4d7c6f] text-white px-6 py-2 rounded-lg hover:bg-[#5d8c7f] transition-all font-medium">
            {{ 'DASHBOARD.ADD_NEW_ITEM' | translate }}
          </button>
        </div>
      } @else {
        <!-- Desktop Table View -->
        <div class="hidden lg:block overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="bg-surface-container">
                <th class="text-left px-6 py-4 text-xs font-medium text-slate-500 uppercase tracking-wider min-w-[300px]">{{ 'DASHBOARD.TABLE.ITEM' | translate }}</th>
                <th class="text-left px-6 py-4 text-xs font-medium text-slate-500 uppercase tracking-wider min-w-[120px]">{{ 'DASHBOARD.TABLE.CATEGORY' | translate }}</th>
                <th class="text-left px-6 py-4 text-xs font-medium text-slate-500 uppercase tracking-wider">{{ 'DASHBOARD.TABLE.QUANTITY' | translate }}</th>
                <th class="text-left px-6 py-4 text-xs font-medium text-slate-500 uppercase tracking-wider">{{ 'DASHBOARD.TABLE.PRICE' | translate }}</th>
                <th class="text-left px-6 py-4 text-xs font-medium text-slate-500 uppercase tracking-wider min-w-[100px]">{{ 'DASHBOARD.TABLE.STATUS' | translate }}</th>
                <th class="text-left px-6 py-4 text-xs font-medium text-slate-500 uppercase tracking-wider">{{ 'DASHBOARD.TABLE.ACTIONS' | translate }}</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[#1e1e1e]">
              @for (item of items(); track trackByFn($index, item)) {
                <tr
                  (click)="viewItem(item)"
                  class="hover:bg-[#1e1e1e] transition-colors cursor-pointer group">
                  <!-- Item Column -->
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 bg-[#2d4a3f] rounded-lg flex items-center justify-center flex-shrink-0">
                        <lucide-icon name="Package" class="!w-5 !h-5 text-[#4d7c6f]"></lucide-icon>
                      </div>
                      <div class="min-w-0 max-w-[350px]">
                        <p class="font-medium text-foreground truncate">{{ item.name }}</p>
                        <p class="text-sm text-slate-500 truncate">{{ item.description || '-' }}</p>
                      </div>
                    </div>
                  </td>

                  <!-- Category Column -->
                  <td class="px-6 py-4">
                    <span class="text-slate-400">{{ item.category }}</span>
                  </td>

                  <!-- Quantity Column -->
                  <td class="px-6 py-4">
                    <span class="text-foreground font-medium">{{ item.quantity }}</span>
                  </td>

                  <!-- Price Column -->
                  <td class="px-6 py-4">
                    @if (item.price) {
                      <span class="text-foreground font-medium">{{ formatCurrency(item.price, item.currency) }}</span>
                    } @else {
                      <span class="text-slate-600">-</span>
                    }
                  </td>

                  <!-- Status Column -->
                  <td class="px-6 py-4">
                    <span
                      [ngClass]="{
                        'text-emerald-400 bg-emerald-950/50 border border-emerald-900': item.status === 'IN_STOCK',
                        'text-orange-400 bg-orange-950/50 border border-orange-900': item.status === 'LOW_STOCK',
                        'text-rose-400 bg-rose-950/50 border border-rose-900': item.status === 'OUT_OF_STOCK'
                      }"
                      class="px-3 py-1 rounded-md text-xs font-medium inline-block">
                      {{ getStatusKey(item.status) | translate }}
                    </span>
                  </td>

                  <!-- Actions Column -->
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-1">
                      <button
                        type="button"
                        (click)="$event.stopPropagation(); viewItem(item)"
                        class="p-2 rounded-lg text-slate-500 hover:text-sky-400 hover:bg-sky-950/30 transition-colors">
                        <lucide-icon name="Eye" class="!w-5 !h-5"></lucide-icon>
                      </button>
                      <button
                        type="button"
                        (click)="$event.stopPropagation(); editItem(item)"
                        class="p-2 rounded-lg text-slate-500 hover:text-foreground hover:bg-[#2a2a2a] transition-colors">
                        <lucide-icon name="Pencil" class="!w-5 !h-5"></lucide-icon>
                      </button>
                      <button
                        type="button"
                        (click)="$event.stopPropagation(); deleteItem(item)"
                        class="p-2 rounded-lg text-slate-500 hover:text-rose-400 hover:bg-rose-950/30 transition-colors">
                        <lucide-icon name="Trash2" class="!w-5 !h-5"></lucide-icon>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Mobile Card View - GRID 2 COLUMNS -->
        <div class="lg:hidden p-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            @for (item of items(); track trackByFn($index, item)) {
              <div
                class="bg-[#141414] border border-theme rounded-xl p-3 hover:border-slate-600 transition-colors cursor-pointer"
                (click)="viewItem(item)">
                <!-- Status Badge -->
                <div class="flex justify-between items-start mb-2">
                  <div class="w-8 h-8 bg-[#2d4a3f] rounded-lg flex items-center justify-center flex-shrink-0">
                    <lucide-icon name="Package" class="!text-[#4d7c6f] !w-4 !h-4"></lucide-icon>
                  </div>
                  <span
                    [ngClass]="{
                      'bg-emerald-950/50 text-emerald-400': item.status === 'IN_STOCK',
                      'bg-orange-950/50 text-orange-400': item.status === 'LOW_STOCK',
                      'bg-red-950/50 text-red-400': item.status === 'OUT_OF_STOCK'
                    }"
                    class="px-1.5 py-0.5 rounded text-[10px] font-medium">
                    {{ getStatusKey(item.status) | translate }}
                  </span>
                </div>

                <!-- Item Name -->
                <h3 class="font-semibold text-foreground text-sm mb-1 truncate">{{ item.name }}</h3>
                <p class="text-slate-500 text-xs truncate mb-2">{{ item.category }}</p>

                <!-- Quick Info -->
                <div class="flex items-center justify-between text-xs mb-2">
                  <span class="text-slate-400">Cant: <span class="text-foreground font-medium">{{ item.quantity }}</span></span>
                  @if (item.price) {
                    <span class="text-emerald-400 font-medium">{{ formatCurrency(item.price, item.currency) }}</span>
                  }
                </div>

                <!-- Actions -->
                <div class="flex justify-end gap-1 pt-2 border-t border-[#1e1e1e]">
                  <button
                    type="button"
                    (click)="$event.stopPropagation(); viewItem(item)"
                    class="p-1.5 rounded-lg text-slate-500 hover:text-sky-400 hover:bg-sky-950/30 transition-colors">
                    <lucide-icon name="Eye" class="!w-4 !h-4"></lucide-icon>
                  </button>
                  <button
                    type="button"
                    (click)="$event.stopPropagation(); editItem(item)"
                    class="p-1.5 rounded-lg text-slate-500 hover:text-foreground hover:bg-[#2a2a2a] transition-colors">
                    <lucide-icon name="Pencil" class="!w-4 !h-4"></lucide-icon>
                  </button>
                  <button
                    type="button"
                    (click)="$event.stopPropagation(); deleteItem(item)"
                    class="p-1.5 rounded-lg text-slate-500 hover:text-rose-400 hover:bg-rose-950/30 transition-colors">
                    <lucide-icon name="Trash2" class="!w-4 !h-4"></lucide-icon>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>

      <!-- Quick Actions -->
      <div class="mt-6 flex flex-wrap gap-4">
        <button
          (click)="addNewItem()"
          class="bg-[#4d7c6f] text-white px-6 py-2 rounded-lg hover:bg-[#5d8c7f] transition-all font-medium">
          {{ 'DASHBOARD.ADD_NEW_ITEM' | translate }}
        </button>
        <button
          (click)="viewAllInventory()"
          class="bg-slate-800 text-foreground px-6 py-2 rounded-lg hover:bg-slate-700 transition-all font-medium">
          {{ 'COMMON.VIEW_ALL' | translate }} {{ 'NAV.INVENTORY' | translate }}
        </button>
      </div>
    }
  </div>
</div>
